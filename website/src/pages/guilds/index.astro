---
import { getCollection } from "astro:content";
import Base from "../../layouts/Base.astro";
import Breadcrumbs from "../../components/Breadcrumbs.astro";
import GearDivider from "../../components/GearDivider.astro";
import EntryCard from "../../components/EntryCard.astro";

const allLore = await getCollection("lore");

const guildEntries = allLore.filter((entry) => {
  const title = entry.data.title.toLowerCase();
  const tags = entry.data.tags.map((t) => t.toLowerCase());
  return (
    title.includes("guild") ||
    tags.includes("guild") ||
    tags.includes("guilds") ||
    entry.data.category === "factions" ||
    entry.data.category === "professions"
  );
});

function getExcerpt(content: string, maxLength = 120): string {
  const text = content.replace(/^#.*$/gm, "").trim();
  if (text.length <= maxLength) return text;
  return `${text.slice(0, maxLength).trim()}...`;
}

const guilds = [
  {
    name: "Engineer's Guild",
    icon: "M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z",
    description:
      "Masters of Whisker-Punk technology, the engineers design and maintain the gear-towers, kinetic paths, and mechanical wonders that power civilization.",
    specialties: ["Mechanics", "Innovation", "Power Systems"],
  },
  {
    name: "Merchant's Guild",
    icon: "M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z",
    description:
      "Controllers of trade and commerce, the merchants manage the flow of goods, currency, and economic prosperity across all five provinces.",
    specialties: ["Trade", "Finance", "Negotiation"],
  },
  {
    name: "Healer's Guild",
    icon: "M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z",
    description:
      "Practitioners of medicine and spiritual healing, the healers tend to both body and mind using ancient techniques and modern understanding.",
    specialties: ["Medicine", "Wellness", "Spiritual Care"],
  },
  {
    name: "Farmer's Collective",
    icon: "M12 22a9.733 9.733 0 0 1-3.67-.71c-.27-.1-.5-.28-.66-.52-.16-.24-.24-.52-.24-.81V19a6.5 6.5 0 0 1-4.18-3.08 6.5 6.5 0 0 1 .74-7.38A6.5 6.5 0 0 1 11.5 6v.5A2.5 2.5 0 0 0 14 9h.5a6.47 6.47 0 0 1 5.5 3.5 6.5 6.5 0 0 1-4 9.04v-.58c0-.29-.08-.57-.24-.81-.16-.24-.39-.42-.66-.52A9.73 9.73 0 0 1 12 22z",
    description:
      "Stewards of the land, the collective manages agriculture, food production, and maintains the delicate balance between civilization and nature.",
    specialties: ["Agriculture", "Land Care", "Food Production"],
  },
  {
    name: "Artisan's Union",
    icon: "M7 5h2V3H7v2zm0 8h2v-2H7v2zm0 8h2v-2H7v2zm4-4h2v-2h-2v2zm0 4h2v-2h-2v2zm-8 0h2v-2H3v2zm0-4h2v-2H3v2zm0-4h2v-2H3v2zm0-4h2V7H3v2zm0-4h2V3H3v2zm8 8h2v-2h-2v2zm8 4h2v-2h-2v2zm0-4h2v-2h-2v2zm0 8h2v-2h-2v2zm0-12h2V7h-2v2zm-8 0h2V7h-2v2zm8-6v2h2V3h-2zm-8 2h2V3h-2v2zm4 16h2v-2h-2v2zm0-8h2v-2h-2v2zm0-8h2V3h-2v2z",
    description:
      "Craftscats of exceptional skill, the artisans create everything from daily necessities to treasured works of art that define Neko-kuni's aesthetic.",
    specialties: ["Craftsmanship", "Arts", "Skilled Trades"],
  },
  {
    name: "Scholar's Circle",
    icon: "M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z",
    description:
      "Keepers of knowledge and history, the scholars preserve ancient wisdom, conduct research, and educate the next generation of cat citizens.",
    specialties: ["Education", "Research", "History"],
  },
  {
    name: "Performance Guild",
    icon: "M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z",
    description:
      "Artists of entertainment and cultural preservation, the performers maintain traditions through theater, music, storytelling, and celebration.",
    specialties: ["Entertainment", "Arts", "Cultural Preservation"],
  },
];
---

<Base title="The Seven Guilds" description="Learn about the seven major guilds of the Whisker Shogunate.">
  <div class="page">
    <header class="page__header">
      <div class="page__header-inner">
        <Breadcrumbs
          items={[
            { label: "Home", href: `${import.meta.env.BASE_URL}` },
            { label: "Guilds" },
          ]}
        />
        
        <div class="page__title-section">
          <h1 class="page__title">The Seven Guilds</h1>
          <p class="page__description">
            The guilds form the backbone of Neko-kuni's economy and society. Each represents 
            a vital aspect of civilization, offering paths to mastery and purpose for cats 
            seeking their place in this new world.
          </p>
        </div>
      </div>
    </header>

    <main class="page__content">
      <section class="guilds">
        <div class="guilds__grid">
          {guilds.map((guild, index) => (
            <article class="guild-card" style={`--delay: ${index * 80}ms`}>
              <div class="guild-card__icon">
                <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
                  <path fill="currentColor" d={guild.icon} />
                </svg>
              </div>
              <div class="guild-card__content">
                <h2 class="guild-card__name">{guild.name}</h2>
                <p class="guild-card__description">{guild.description}</p>
                <div class="guild-card__specialties">
                  {guild.specialties.map((specialty) => (
                    <span class="guild-card__tag">{specialty}</span>
                  ))}
                </div>
              </div>
            </article>
          ))}
        </div>
      </section>

      {guildEntries.length > 0 && (
        <section class="related">
          <GearDivider />
          <h2 class="related__title">Related Lore</h2>
          <div class="related__grid stagger-children">
            {guildEntries.slice(0, 8).map((entry) => (
              <EntryCard
                title={entry.data.title}
                category={entry.data.category}
                slug={entry.id.split("/").pop()!.replace(/\.md$/, "")}
                excerpt={getExcerpt(entry.body || "")}
                tags={entry.data.tags}
              />
            ))}
          </div>
        </section>
      )}
    </main>
  </div>
</Base>

<style>
  .page__header {
    background-color: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-8) var(--space-4) var(--space-12);
  }

  @media (min-width: 768px) {
    .page__header {
      padding: var(--space-10) var(--space-8) var(--space-16);
    }
  }

  .page__header-inner {
    max-width: var(--max-width-content);
    margin-inline: auto;
  }

  .page__title-section {
    margin-top: var(--space-8);
  }

  .page__title {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    font-weight: 500;
    color: var(--color-text-primary);
    margin: 0 0 var(--space-4) 0;
  }

  @media (min-width: 768px) {
    .page__title {
      font-size: var(--text-5xl);
    }
  }

  .page__description {
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    max-width: 700px;
    line-height: var(--leading-relaxed);
    margin: 0;
  }

  .page__content {
    padding: var(--space-8) var(--space-4);
    max-width: var(--max-width-wide);
    margin-inline: auto;
  }

  @media (min-width: 768px) {
    .page__content {
      padding: var(--space-12) var(--space-8);
    }
  }

  /* Guilds */
  .guilds__grid {
    display: grid;
    gap: var(--space-5);
  }

  @media (min-width: 768px) {
    .guilds__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1200px) {
    .guilds__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .guild-card {
    display: flex;
    gap: var(--space-5);
    background-color: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    opacity: 0;
    animation: slide-up var(--duration-slow) var(--ease-out-expo) forwards;
    animation-delay: var(--delay);
    transition: 
      transform var(--duration-normal) var(--ease-out-expo),
      box-shadow var(--duration-normal) var(--ease-out-expo),
      border-color var(--duration-normal) var(--ease-out-expo);
  }

  .guild-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
    border-color: var(--color-accent-secondary);
  }

  .guild-card__icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3.5rem;
    height: 3.5rem;
    background: linear-gradient(135deg, var(--color-accent-secondary), var(--color-accent-tertiary));
    border-radius: var(--radius-lg);
    color: var(--color-bg-primary);
  }

  .guild-card:hover .guild-card__icon {
    transform: scale(1.05);
  }

  .guild-card__icon svg {
    width: 1.75rem;
    height: 1.75rem;
    transition: transform var(--duration-normal) var(--ease-out-expo);
  }

  .guild-card__content {
    flex: 1;
    min-width: 0;
  }

  .guild-card__name {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text-primary);
    margin: 0 0 var(--space-2) 0;
    transition: color var(--duration-fast) var(--ease-out-expo);
  }

  .guild-card:hover .guild-card__name {
    color: var(--color-accent-secondary);
  }

  .guild-card__description {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed);
    margin: 0 0 var(--space-4) 0;
  }

  .guild-card__specialties {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .guild-card__tag {
    font-size: var(--text-xs);
    padding: var(--space-1) var(--space-2);
    background-color: var(--color-bg-secondary);
    color: var(--color-text-tertiary);
    border-radius: var(--radius-md);
    transition: all var(--duration-fast) var(--ease-out-expo);
  }

  .guild-card:hover .guild-card__tag {
    background-color: var(--color-accent-secondary);
    color: var(--color-bg-primary);
  }

  /* Related */
  .related__title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 500;
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .related__grid {
    display: grid;
    gap: var(--space-5);
  }

  @media (min-width: 640px) {
    .related__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .related__grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }
</style>
